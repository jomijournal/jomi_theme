<?php

/*
............DN............Z7........................................................................
............NI7...........?,I$..........................=$Z7??88....................................
............DZ8M,.........:,,,I.......................~NZI????????..................................
............=MMMD.......=M+=,,,,:....................?$??$$=??I??I?I................................
..............MMO8.....,DI+=,,,,?:..................?M?O?N?+OZ7N?I??................................
.............,+=I$...,N$+I++~,,,:+..................88$87     Z    ?7...............................
..Z+?.........MMM877II+?I$7I++Z?,:=.................7MMMM$778D8$MMZN??..............................
..?:~I+=....~?MM~~?I7?II$$7I77:7,,O...............I$NNZ8M   MMM   MM?7..............................
..,,+NM8II$7II8MI:+???+?ZZODI?=I,,8=..............8NMN7 77ZZI7ZZ$NMD ?..............................
..,,IMMDO877I?$MM8+?II?+7OZ7D8II,,Z~..............NMODM$  8DOZZOMM  ZOO.............................
..~,IMNNOD7III7OMM:+II77DDDMDDZ+,,Z~..............MNZM8$7Z        ZMMNM.............................
..I,:ZMD8OIIIIII$M7+DMM$.....=MD,~8..............:M8ZMNZ$$NNDOZZNMMMMMO.............................
..=D:~MZ$OZZI7I?+$OM?+$M........$I..................7OMMM??I7ZOMMMMMM$..............................
....I+7$Z8O8OO??D:.:MMMMM~...........................7NMMNMMMMMMMMZ................................
....~,:+8ZO8ODDD....7MZMMI............................DDO8ZZNMNZ8MNMMMMD,...........................
.....?,,:?Z7$M........MM=7....................IMMNDM7$MD$$$ZZOZZMMMMNMMMDNZNMMDODNN$................
......+,,:+$N.........7MOO=.................:8DNM8ZN7ZZ$Z7OZMOZZ8NMZ8O$IMM8O$Z$$Z$ZNMN..............
.......+,,:~7..........D+=~?.,...........ZN88DDZMM8OZZ$7DZ777ZZZNMNMD8ODMMM8Z$777ZZOMD8=............
..........I78.........8=?Z8OOO=.......=M7?7$NMMDMMM8MOI??7==?I$D77MMMDMMZZMM88Z=~+7ZZ8Z?:...........
......................7Z$I7778~......:Z+=IZ8ZZ8M7777$MI77I~=?7MMO$Z$$MNZZZZZNNN7=~IZZZZ7D...........
.....................?O7I7$77$?.....,M+=Z$ZZ$7I$OMNDDN8ZZ$~+7ZDDMMMOMM?7$ZZZZZN8$777Z$ZZNZ..........
.....................,MMI?Z$8MDO....7O?7Z7?=????M8MMZZMMZZMIMOION8ZM+~~?ZZZZZZMMZZ$Z$$ZZM87?8.......
......................8$8$$$IZMM....=D7Z$7=~~+??$N7$I7DNMMMMN7I777MI~:I7$ZZZZZNMNN8OZZZZ8MZZ?$......
......................DZ787$8MMM.....O88$7+~~=??7ZM$777$77O777I77OI==?I7$ZZZZZMM8Z$$ZZZZ$7ZZ$7=.....
......................=OO8O8MM7+7.$M7?7$M$?+=~??7$M8I7NMMM8M77$$MN+?77$$ZZZZONMMO7=~?77$+IZZZZO$....
.......................IONND$M7I$~8I~++IDMZ$8NOIZ$M8$NMMMMMNMM7ZM877$8D8ZZZOMMMM8?~~~=+==7ZZZZ8M....
........................NDMN$88?IDI=~~+?Z8MMN8OOODMNMMNM$8MNND7$MMZ8DDMMMMMMM8DMMM=:=+=~~?ZZZZ$M....
........................MMMMZ$NM+ID7??I7ZZMMMMZZZZM88MMMMMMMMM$7MZZ7$ZZZ8MDIZZZZMMMMMM$Z777ZZZZ$=...
........................8DMMN8MM8?OMN8$$ZZMMMDZ$Z88O7ZZMMMMM$7$ZNI7III$ZMMMMOZZ8N,..ZN8NDOZOZZZ7=...
..........................DNMMN8M7IZZZNOO8MMOZI7DMO$7$7$ZO8O$$$$DM$$ZZ7O88MO88NM....INZ7==?$ZZMZZ...
...........................OMMNO7M+?D8Z8MMO8MMNM7$77ZZDMNMMM8O77IZNMZ$Z8MNMDDNN:..N7I7ZZZZZZMMMMM:..
............................MM$$7$$+?DZZMMMMMMMN$7$Z$Z8????IMM$77$O8MM8DNMMMMD...$7$8ZZ8Z88MMMDNM7..
............................MMZOZ$MD?IOZMMD?MMMMMM87N8?==?++7OMO7$$OMMMMMMMM~...=N8ZZZZZZZZ8N8MM....
............................=MMMMMIM$I8NM7..+MMMMMMM$77$ZO8OZZDMMM8MMMMMMMMM=Z8ZII?I$ZO8ZZO8M8......
..............................DMMMNO8?$D,....:MMMMMMMDZZI78DN88DNMMMMMMMMMMM$?=?7$ZZZZ8NMMMM........
................................:DMMMM?I=.....?M77ZZI7?+???++7$ZZZMMMMMMMMD7??$ZZZZZNM8DMZ..........
.....................................,8?O7....MM7?7OMN$ZZZ88OZZO8NMMMMMM8DOZZN88MMNN8?..............
......................................O7?Z...=NN8D8DDNM88NNNMMNNMMDN8ONMOOZZZ8MMMO..................
.......................................DI7?.~M$$$Z$7$ONNOZ$$Z$$ZZ$$$8$MMDOOZZON,....................
........................................DDZ$8N87MODD$NM$$$88O7M$$O$ZNMONNOZ8MD......................
........................................OM8DMO7$MMMNOM8Z8ZN8O78MNO$$$ZNMMMNM........................
..........................................MMMMMMOO$$$DNMMNDZ$7$$88NMMMMMMMMN........................
..........................................=MMMMMNNMMD$ZONMMN8ZZOMMMMMMMMMMM.........................
..........................................:MMMMMNMNDNNMMMMNOOMMMMMMMMMMNZMD.........................
..........................................Z7MNMMMMMDNNDNNNMNNMMMMMMMD7D$Z7M~........................
........................................$88M=+?7MMMMMDDNNNMMMMMMMMZ=+??O$ZIN........................
........................................ZINI?II77ZMMMMMMNNMNMMMMNDI?~?7?ZZ7?7.......................
.......................................877$?7ID=?IIOMMMMMMNMMMD$7787+?7777ZI8=......................
......................................N$78$ZDO~~777?ZMMMMMMMMM$7II$ZZ7Z7Z?Z$=8......................
......................................8+$8ZZZ+~?7$I?I78MMMMMMMZ$7I?$ZOZ$I?ZZ?I......................
.....................................,7+7DZ7=~?7Z$?+$Z$DMMMMNM8Z$I+?$ZOD~=$ZI?:.....................
.....................................Z7=?OOI~:I7Z$??8$7Z?...NI8M$7???IZN7I$Z7II.....................
.....................................Z7??7NI~~77ZZ?DZZ7N....NN$D$7??~+7ZZ?7$$77.....................
.....................................D$7?$O?~~7ZZ$IDZZMD....:M88$7??~=7$7I$$Z7M,....................
.....................................$7I7Z7?~=7$ZZZNMM~.......NMD$??~~77$$$ZZ7M,....................
.....................................~$$7Z$?+?7ZZZ8MMO.........:MOI?~=7$ZZZZZ$M.....................
......................................Z7$ZZ$?I7ZZZMM=...........D87I=?$ZZZZZZN8.....................
......................................DD$ZZ$$$ZZZZMM.............O$7?7ZZZZM88M:.....................
......................................,MMOZZ$$ZZZZMO.............7Z$$ZZZZOMMMM......................
........................................M8ZOZZZZOMM?.............,NZ$ZZZ$8ZNMM......................
........................................MOZOZ88DMMN...............DMD8O8N8ZZMN......................
.......................................=87$ZMMMMM87................8MMMMO$ZZ8M......................
.......................................O7+7$8MMMZN:.................MMMMI+$ZZ8=.....................
......................................ND?+$Z77ZZ8M..................:MMM8?+7ZMNN....................
.....................................:O8NZZZDNZ7N.....................MMMMOZOMNNM=..................
.....................................?OZNZZOMD78.......................ZNN8ZMM88Z8,.................
.....................................$$ZMDZZZ$M=........................DMO8MMZ$OZOM................
....................................ZZZ8MNZZZ8M=........................8NMZ7ZZ$MZZ88...............
....................................$?77O8ZZNNMM........................ZZMD$ZZZM888M$..............
...................................?77D7$ZZZ8ZMM........................$ZZ8ZZZ8DZMMNM..............
................................,Z8$7$777$ZZOOMM........................M8ZOMNOZ8MZDNM~.............
................................8O?=????IZZ8OO8?Z7......................MMZZ77777I77~~MN............
................................DM+??????N++OOI7$8......................M$+++=++?++?I?OZ............
................................I$ZDOOOZMOI?OM78N+.....................?MM?I??+?8?+?NZMD............
.................................IMMNMMMMNMDMDMM$N.....................~8ZDOD7IDOMO7MMMD............
..................................=MMMMMMNNMM$$..........................~MMMMMNMMMMMM8.............
...................................DMMMMDDMMND..............................MMMDNMNMMMZ.............
...................................DMMN8MMMMM8..............................MMMMN8MMMM7.............
...................................DMMMMNMMMI................................IMMNMDNMM~.............
...................................,MMMMNNMM..................................MMMMMNMN..............
....................................MMMMMMMD..................................,MMMMMMM..............
....................................NMMMDMMM...................................NNNNDMM..............
....................................8MNNNMMM..................................~MMMMMMM:.............
....................................NMMMNMMM?.................................NMMMNNMMD.............
..................................MMMMMMNNNDM~................................MMMMMMMNMM7...........
...............................?MMMMMMMNMMMMM?................................MMMMMMMMMMO$..........
............................OMMMMMMMMMMMMMMMN.................................MMMMNNMMMMD8..........
.........................7MMMMMMMMMMMM$=.......................................7MMMM8Z7I............
.........................:MMMMMMMD=.................................................................
....................................................................................................
 */

//* FUNCTIONS.PHP
//* ALL OF THIS IS EXECUTED AT RUNTIME 

/** set environment flags **/



function set_env_flag() {

	$local_envs = array (
		'localhost',
		'jomi',
		'127.0.0.1'
	);

	if(!empty($_GET['setenv'])) {
		define('WP_ENV', $_GET['setenv']);
	} elseif (in_array($_SERVER['HTTP_HOST'], $local_envs)) {
		define('WP_ENV','TEST');
	} else {
		define('WP_ENV','PROD');
	}

	
}
add_action('init', 'set_env_flag');

/* COMPOSER INCLUDES */
require_once('vendor/autoload.php');

/* SET UP GEOIP */
use GeoIp2\Database\Reader;
global $reader;
$reader = new Reader(ABSPATH . '/wp-content/themes/jomi/assets/data/geolite2/GeoLite2-City.mmdb');

/* SET UP STRIPE */
if('WP_ENV' == 'PROD') {
	Stripe::setApiKey(get_option("stripe_live_secret_api_key"));
} else {
	Stripe::setApiKey(get_option("stripe_test_secret_api_key"));
}

global $user_stripe_subscribed;
$user_stripe_subscribed = false;

/**
 * Roots includes
 */
$roots_includes = array(
	'/lib/utils.php'             // Utility functions
	, '/lib/init.php'            // Initial theme setup and constants
	, '/lib/wrapper.php'         // Theme wrapper class
	, '/lib/sidebar.php'         // Sidebar class
	, '/lib/config.php'          // Configuration
	, '/lib/activation.php'      // Theme activation
	, '/lib/titles.php'          // Page titles
	, '/lib/cleanup.php'         // Cleanup
	, '/lib/nav.php'             // Custom nav modifications
	, '/lib/gallery.php'         // Custom [gallery] modifications
	, '/lib/comments.php'        // Custom comments modifications
	, '/lib/relative-urls.php'   // Root relative URLs
	, '/lib/widgets.php'         // Sidebars and widgets
	, '/lib/scripts.php'         // Scripts and stylesheets
	, '/lib/custom.php'          // Custom functions
);
$jomi_includes = array(
	'/lib/jomi/admin.php'            // admin usability and visual improvements
	, '/lib/jomi/access_logic.php'   // access frontend check and block displays
	, '/lib/jomi/access_db.php'      // access db management
	, '/lib/jomi/access_util.php'    // access helper functions
	, '/lib/jomi/access_ui.php'      // access ui + javascript
	, '/lib/jomi/access_blocks.php'  // access block templates
	, '/lib/jomi/article_count.php'  // count # of articles published/preprinted
	, '/lib/jomi/db_switch.php'      // db switch utility on dashboard
	, '/lib/jomi/inst_db.php'        // institution db management
	, '/lib/jomi/inst_ui.php'        // institution admin UI
	, '/lib/jomi/login.php'          // login page utility and restyling
	, '/lib/jomi/post_status.php'    // register post statuses
	, '/lib/jomi/post_types.php'     // register post types (article)
	, '/lib/jomi/referral_db.php'    // referral DB management
	, '/lib/jomi/rewrite.php'        // rewrite rules for articles
	, '/lib/jomi/sidebars.php'       // custom sidebars
	, '/lib/jomi/stripe.php'         // stripe-php helper functions
	, '/lib/jomi/relevanssi.php'     // relevanssi (search) modifications
	, '/lib/jomi/user_orders.php'    // user order logic and UI
	, '/lib/jomi/vid_length.php'     // video thumbnail length code
	, '/lib/jomi/yoast_seo.php'      // SEO mods and improvements
);

$includes = array_merge($jomi_includes, $roots_includes);

foreach($includes as $file){
	if(!$filepath = locate_template($file)) {
		trigger_error("Error locating `$file` for inclusion!", E_USER_ERROR);
	}

	require_once $filepath;
}
unset($file, $filepath);

// get rid of stupid wpautop
remove_filter('the_content', 'wpautop');
remove_filter('the_excerpt', 'wpautop');

/**
 * check if user is admin so we can do a bunch of wack stuff without polluting the main site
 * @return [type] [description]
 */
function check_user_admin() {
	global $is_user_admin;
	global $current_user;
	if(in_array('administrator', $current_user->roles)) {
		$is_user_admin = true;
	} else {
		$is_user_admin = false;
	}
}
add_action('init', 'check_user_admin');

function start_php_session() {
	session_start();

	$curtime = time();
	$expiretime = $_SESSION['expiretime'];

	// if 10 days later, or not set, clear all session vars
	if(empty($expiretime) || $curtime >= $expiretime) {
		reset_session();
	}
}
add_action('init', 'start_php_session');

function reset_session() {
	session_unset();

	$curtime = time();
	$_SESSION['expiretime'] = $curtime + 864000; //expire after 10 days
}

function reset_coupon_session() {
	if(!is_page_template('pages/pricing.php')) {
		$_SESSION['coupons'] = null;
		$_SESSION['referral'] = null;
	}
}
add_action('pre_get_posts', 'reset_coupon_session');

function sitemap_register_preprint($where_filter) {
	$where_filter = "OR post_status IN ('publish','preprint','inherit')";
	return $where_filter;
}
add_filter('wpseo_typecount_where', 'sitemap_register_preprint', 10, 1);


// parse api_keys.json
function parse_api_keys() {
	$file_path = ABSPATH . 'wp-content/themes/jomi/api_keys.json';

	if(file_exists($file_path)) {
		// load into array
		$api_keys = file_get_contents($file_path);
		$api_keys = json_decode($api_keys, true);

		// abort if bad json
		if(empty($api_keys)) return;

		while ($api_key = current($api_keys)) {

			$key = key($api_keys);
			$val = $api_keys[$key];

			$key .= '_api_key';

			update_option($key, $val);

			next($api_keys);
		}
	}
}
add_action('init', 'parse_api_keys');

function send_notification_email() {
	$content = $_POST['content'];
	$email = $_POST['email'];

	// dont send if nothing is requested
	if(empty($content)) return;

	// if no one to be notified, dont send
	if(empty($email)) return;

	$admin_email = get_option('admin_email');

	$body_for_user = 'Thank you for requesting to be notified when [' . $content . '] is released!<br><br>';
	$body_for_user .= 'We will get back to you as soon as it is published.<br>';

	wp_mail($email, 'Content Notification', $body_for_user);

	$body_for_admin = $email . ' requested to be notified when [' . $content . '] is released.<br>';

	wp_mail('contact@jomi.com', 'Content Notification', $body_for_admin);

}
add_action( 'wp_ajax_nopriv_send-notification-email', 'send_notification_email' );
add_action( 'wp_ajax_send-notification-email', 'send_notification_email' );

// Bug testing only. Not to be used on a production site!!
/*add_action('wp_footer', 'roots_wrap_info');

function roots_wrap_info() {  
	$format = '<h6>The %s template being used is: %s</h6>';
	$main   = Roots_Wrapping::$main_template;
	global $template;

	printf($format, 'Main', $main);
	printf($format, 'Base', $template);
}*/



/**
 * Grab referral if we are going to register
 * later add it to admin email
 * if they register
***/
function register_referel() {
    if (htmlentities($_SERVER['REQUEST_URI'], ENT_QUOTES)=='/register/'){
        $cookie=htmlentities($_SERVER['HTTP_REFERER'], ENT_QUOTES);
        setcookie('refer_cookie',$cookie, time()+10000, COOKIEPATH, COOKIE_DOMAIN, false);
     }
}

add_action('init', 'register_referel');

//Add referrer to email message if going to admin only
//Strip out http because mandrill api will change all links in email
function mrefer_add($message){
       	if($message['to']['0']['email']=='dev@jomi.com' || 'cook@jomi.com'){
	//	$refer_strip=str_replace('http', '', $_COOKIE['refer_cookie']);
        $refer_strip=$_COOKIE['refer_cookie'];	
	$message['template']['content']['0']['content']=$message['template']['content']['0']['content'].$refer_strip;
		return $message;
	}
    return $message;
}
add_filter('mandrill_payload','mrefer_add');
//*/
//mandrill_payload is correct filter for this not wp_mail.

function on_wp_login( $user_login, $user ){
	echo '<script>
		 mixpanel.identify(' . $user->ID . ');
		 mixpanel.people.set( { $email: "'.$user->user_email.'" } );
		
		 mixpanel.track( "Login" );
		</script>';
}
add_action( 'wp_login', 'on_wp_login', 10, 2 );

function on_init()
{   
	echo '<script>
                 mixpanel.track( "Visit " + location.pathname.substring(1) );
              </script>';
}
add_action( 'wp_footer', 'on_init' );

function print_r_pre($val) {
	echo '<pre>';
	print_r($val);
	echo '</pre>';
}

?>
